app.controller("navbarController",function($rootScope,$scope){$scope.back=function(){history.back()}}),app.controller("productListController",function($rootScope,$templateCache,$scope,httpRequest,dataStringify,analytics,$location,$window,$routeParams){var code=$routeParams.code||0;$scope.isSearchPage=!1,$scope.showSearch=function(){$location.path("/productsSearch")},$scope.$on("CtrlSearchPanel",function(event,isSearchPage){isSearchPage||$("#searchPage").removeClass("current"),$scope.isSearchPage=isSearchPage}),$rootScope.categoryId=code,$scope.code=code,$scope.user=getToken();var loadObj=new loadControl("#myLoadCanvas",function(){$(".pull-loading").html("加载中..."),$scope.pageNum++,appendGoods($scope.pageNum)}),getCategories=function(){var cat=$rootScope.categories;cat&&cat.length?($scope.categories=cat,$rootScope.initNav(cat)):httpRequest.APIPOST("/goods/category_v1.3",dataStringify("platform=all"),{"content-type":"application/x-www-form-urlencoded"}).then(function(result){if(result&&result.code==statusCode.Success){var cat=result.result;$scope.categories=cat,$rootScope.initNav(cat)}else alertWarning(result.msg)})},appendGoods=function(pageNum){var now=(new Date).format("yyyy-mm-dd HH:MM:ss");$scope.isloading=!0;var paramCategory=code?"&category="+code:"",ldToken=$scope.user?"&token="+$scope.user.token:"";httpRequest.APIPOST("/goods/listByCategoryLd",dataStringify("platform=all"+ldToken+paramCategory+"&pageNo="+pageNum+"&pageSize=20&now="+now),{"content-type":"application/x-www-form-urlencoded"},1==pageNum?!0:!1).then(function(result){result&&result.code==statusCode.Success?(pageNum>1?($scope.products=$scope.products.concat(result.result),$scope.pageCount=result.page.totalPage,$scope.pageNum=pageNum):($scope.products=result.result,$scope.pageCount=result.page.totalPage,$scope.pageNum=result.page.pageNo),$scope.isloading=!1):($scope.isloading=!1,alertWarning(result.msg))})};getCategories(),appendGoods(1),$(".scrollable-content").scroll(function(){$("#divProducts").length>0&&0==$scope.isloading&&$scope.pageCount&&advanceLoad("#divProductList",loadObj,$scope.pageNum<$scope.pageCount)}),$scope.inquiry=function(){$location.path("/myProfile")},$scope.goProduct=function(id){return id?void($scope.isApp?window.location.href=easybuy.appActivity+"?action=1&goodId="+id:$location.path("/product/"+id+"/1")):void alertWarning("该商品已经下架，请选择其他商品购买^_^")},$scope.drawProductsPanel=function(){$("#divProducts .list-products-item .products-item-image").css("height",$("#divProducts .list-products-item").width()+"px"),$("#divProducts .list-products-item .products-item-title").css("height",$("#divProducts .list-products-item").width()/1.67+"px"),$("#divProducts .list-products-item .products-item-title .products-item-name").css("height",$("#divProducts .list-products-item").width()/4+"px")},$(window).resize(function(){$scope.drawProductsPanel()}),$scope.cart=function(){$location.path("/cart")},$scope.cartNum=function(){httpRequest.APIPOST("/cart/list_v1.4",dataStringify("platform=all&token="+$rootScope.tokenInfo.token),{"content-type":"application/x-www-form-urlencoded"}).then(function(result){var num=0;result&&result.code==statusCode.Success?($scope.cartProducts=result.result.normal,num=$scope.cartProducts.length):(alertWarning(result.msg),num=0),$scope.cartQuantity=num})},$scope.cartNum(),$rootScope.$on("CtrlLoginModule",function(){$scope.cartNum()})}),app.controller("searchPanelController",function($rootScope,$scope,httpRequest,dataStringify,analytics,$location){$scope.back=function(){$location.path("/products")},$scope.goProduct=function(id){return id?void($scope.isApp?window.location.href=easybuy.appActivity+"?action=1&goodId="+id:$location.path("/product/"+id+"/1")):void alertWarning("该商品已经下架，请选择其他商品购买^_^")},$scope.isQuery=!1,$scope.searchKeyword="",$scope.isFocus=!1,$scope.cancelSearch=function(){return $scope.isFocus?($(".search-result").removeClass("focus"),void($scope.isFocus=!1)):($scope.$emit("CtrlSearchPanel",!1),$scope.searchKeyword="",$scope.isLocalKey=!0,$scope.isQuery=!1,void($scope.queryProducts=[]))},$scope.searchLocalItems=getSearchLocalItems()||[],$scope.isLocalKey=!0,$scope.searchKeyup=function(e){return e&&13==e.keyCode&&$scope.searchKeyword.length>0?void $scope.queryGoods($scope.searchKeyword,1):void($scope.searchKeyword.length>0?($scope.isLocalKey=!1,$scope.getSuggestKeywords($scope.searchKeyword)):($scope.isLocalKey=!0,$(".search-result").addClass("focus")))},$("#searchInput").bind("input",function(){$scope.searchKeyup()}),$scope.searchFocus=function(){$("#searchInput").focus(),$scope.searchLocalItems=getSearchLocalItems()||[],$scope.isFocus=!0,$scope.searchKeyword.length>0?($scope.isLocalKey=!1,$scope.getSuggestKeywords($scope.searchKeyword),$scope.isFocus=!1):$scope.searchLocalItems.length>0&&$(".search-result").addClass("focus")},$scope.searchBlur=function(){},$scope.hideSearchDropdown=function(){$(".search-result").removeClass("focus")},$scope.saveSearchKeyword=function(value){setSearchLocalItems(value),$scope.searchKeyword=value,$scope.queryGoods(value,1)},$scope.removeSearchKeyword=function(){setSearchLocalItems(null),$scope.searchLocalItems=[],$(".search-result").removeClass("focus")},$(".search-input").bind("keyup",function(e){13==e.keyCode&&$scope.searchKeyword.length>0&&setSearchLocalItems($scope.searchKeyword)}),$scope.getShowKeywords=function(){httpRequest.APIPOST("/keywords/getShow",dataStringify("platform=all"),{"content-type":"application/x-www-form-urlencoded"}).then(function(result){result&&result.code==statusCode.Success?$scope.hotKeywords=result.result:alertWarning(result.msg)})},$scope.getShowKeywords(),$scope.getSuggestKeywords=function(q){httpRequest.APIPOST("/solr/keywords/suggest",dataStringify("platform=all&area=kr&q="+q),{"content-type":"application/x-www-form-urlencoded"}).then(function(result){result&&result.code==statusCode.Success?($scope.searchItems=result.result,$scope.searchItems.length>0?$(".search-result").addClass("focus"):$(".search-result").removeClass("focus")):alertWarning(result.msg)})},$scope.queryGoods=function(q,pageNo){$(".search-result").removeClass("focus"),$scope.isFocus=!1,$scope.searchKeyword=q,httpRequest.APIPOST("/solr/goods/query",dataStringify("platform=all&q="+q+"&pageNo="+pageNo+"&pageSize=10"),{"content-type":"application/x-www-form-urlencoded"}).then(function(result){result&&result.code==statusCode.Success?($scope.isQuery=!0,pageNo>1?($scope.queryProducts=$scope.queryProducts.concat(result.result),$scope.queryPageCount=result.page.totalPage,$scope.queryPageNum=pageNo):($scope.queryProducts=result.result,$scope.queryPageCount=result.page.totalPage,$scope.queryPageNum=result.page.pageNo)):alertWarning(result.msg)})};var loadObj=new loadControl("#queryLoadCanvas",function(){$(".pull-loading").html("加载中..."),$scope.queryPageNum++,$scope.queryGoods($scope.searchKeyword,$scope.queryPageNum)});$(".scrollable-content").scroll(function(){$("#queryProducts").length>0&&$scope.queryPageCount&&advanceQueryLoad("#queryProductList",loadObj,$scope.queryPageNum<$scope.queryPageCount)}),$scope.drawQueryPanel=function(){$("#queryProducts .list-products-item .products-item-image").css("height",$("#queryProducts .list-products-item").width()+"px"),$("#queryProducts .list-products-item .products-item-title").css("height",$("#queryProducts .list-products-item").width()/1.67+"px"),$("#queryProducts .list-products-item .products-item-title .products-item-name").css("height",$("#queryProducts .list-products-item").width()/4+"px")},$(window).resize(function(){$scope.drawQueryPanel()})}),app.controller("productAppController",function($rootScope,$scope,httpRequest,dataStringify,analytics,$location,$window,$routeParams){$scope.$on("CtrlDownloadShow",function(event,show){$scope.showDownload=show}),$scope.isGo=function(){return!1},httpRequest.APIPOST("/goods/detailLd",dataStringify("platform=all&id="+$routeParams.id),{"content-type":"application/x-www-form-urlencoded"}).then(function(result){if(result&&result.code==statusCode.Success&&($scope.product=result.result,$scope.product)){if($scope.product.num=1,$scope.product.imgs&&$scope.product.imgs.length>0){$(".pager_control").removeClass("hide"),1==$scope.product.favorite&&$(".div-favorite img").attr("src","image/icon_favorite_hover.png"),$(".product-content").html($scope.product.description),$(".product-content").find("img").unbind("click").bind("click",function(){showImageLarger(this)});var control=navigator.control||{};control.gesture&&control.gesture(!1),$scope.product.avgStar=$scope.product.avgStar?$scope.product.avgStar:0,$scope.product.commentNum>0&&($(".rateTotal").raty({path:"image/raty",size:15,score:$scope.product.avgStar,readOnly:!0}),$(".itemRate").raty({path:"image/raty",size:15,score:$scope.product.comment.star,readOnly:!0}))}"undefined"==typeof IScroll?$.ajax({url:"/lib/iscroll.js",dataType:"script",cache:!0,success:function(){$scope.initScroll()}}):$scope.initScroll()}}),$scope.back=function(){1==history.length||$location.search().version?$location.path("/products"):history.back()},$scope.addToCart=function(goodsNum){return 0>=goodsNum?void alertWarning("库存已不足，请稍后购买"):($(".promotePriceNewTotal").html("￥"+$scope.product.promotePrice),void openPrompt("addToCart",function(num){var product=$.extend(!0,{},$scope.product);product.num=num;var data="platform=all&token="+$rootScope.tokenInfo.token+"&goodsId="+product.id+"&quantity="+num;httpRequest.APIPOST("/cart/add",dataStringify(data),{"content-type":"application/x-www-form-urlencoded"}).then(function(result){result&&result.code==statusCode.Success&&(setCart(null),setCart(result.result.normal),closeDialog(),$scope.cartNum(),alertSuccess("加入成功"))})}))},$scope.reduceNum=function(goods){goods.num>1&&goods.num--},$scope.addNum=function(goods){goods.num++},$scope.validNum=function(goods,allowEmpty){if(goods.num=validInteger(goods.num),!allowEmpty||""!=goods.num){var num=parseInt(goods.num);goods.num=isNaN(num)||1>num?1:num}},$scope.go=function(goodsNum){return 0>=goodsNum?void alertWarning("库存已不足，请稍后购买"):void openPrompt("go",function(num){var product=$.extend(!0,{},$scope.product);product.num=num,$scope.product&&(closeDialog(),$location.path("/pay/999").search({goodsId:product.id,quantity:num}),$scope.$apply($location))})},$scope.viewComments=function(){$scope.product&&$scope.product.commentNum>0&&$location.path("/comment/"+$routeParams.id)},$scope.initScroll=function(){for(var i=0;i<$scope.product.imgs.length;i++){var img=$scope.product.imgs[i],p=$scope.product,$img=$("<img />");$img.attr("src",img),$img.attr("title",p.title);var $slide=$('<div class="slide"></div>').append($img);$("#scroller").append($slide),$("#indicator").css("width",15*$scope.product.imgs.length-5+"px"),$(".slide").css("width",100/$scope.product.imgs.length+"%"),$("#scroller").css("width",100*$scope.product.imgs.length+"%")}$("#spanCurrPage").html(1),$("#spanTotalsCount").html($scope.product.imgs.length),$scope.myScroll=null,$scope.myScroll=new IScroll("#wrapper",{scrollX:!0,scrollY:!1,momentum:!1,preventDefault:!1,snap:!0,snapSpeed:100,keyBindings:!0,indicators:{el:document.getElementById("indicator"),resize:!1}});var handler=function(e){e.preventDefault()};$scope.myScroll.on("scrollStart",function(){$("#viewport")[0].addEventListener("touchmove",handler,!1)}),$scope.myScroll.on("scrollEnd",function(){$("#spanCurrPage").html($scope.myScroll.currentPage.pageX+1),$("#viewport")[0].removeEventListener("touchmove",handler,!1)})},$scope.cart=function(){$location.path("/cart")},$scope.cartNum=function(){httpRequest.APIPOST("/cart/list_v1.4",dataStringify("platform=all&token="+$rootScope.tokenInfo.token),{"content-type":"application/x-www-form-urlencoded"}).then(function(result){var num=0;result&&result.code==statusCode.Success?($scope.cartProducts=result.result.normal,num=$scope.cartProducts.length):(alertWarning(result.msg),num=0),$scope.cartQuantity=num})},$scope.cartNum(),$rootScope.$on("CtrlLoginModule",function(){$scope.cartNum()})}),app.controller("downloadController",function($rootScope,$scope,httpRequest,analytics,$location,$window,$routeParams){$scope.type=$routeParams.type,$scope.ProgramTypes=easybuy.ProgramTypes,$scope.mobileType=getMobileType(),$scope.type==$scope.ProgramTypes.APP||getCloseDownloadApp()||($scope.mobileType==MobileTypes.Android&&appDownloadUrl.android&&""!=appDownloadUrl.android?(!isWeixin()||appDownloadUrl.webchat&&""!=appDownloadUrl.webchat)&&($scope.show=!0):($scope.mobileType==MobileTypes.iPhone||$scope.mobileType==MobileTypes.iPad)&&appDownloadUrl.ios&&""!=appDownloadUrl.ios&&(!isWeixin()||appDownloadUrl.webchat&&""!=appDownloadUrl.webchat)&&($scope.show=!0)),$scope.$emit("CtrlDownloadShow",$scope.show);var isXiaoMiBrowser=function(){var ua=navigator.userAgent.toLowerCase();return"miuibrowser"==ua.match(/miuibrowser/i)?!0:!1};$scope.download=function(){isWeibo()||(window.location.href=easybuy.appOpenUrl),$scope.mobileType==MobileTypes.Android&&isXiaoMiBrowser()&&(window.location.href=appDownloadUrl.webchat),window.setTimeout(function(){if(isWeixin()){if($scope.mobileType==MobileTypes.Android)window.location.href=appDownloadUrl.webchat;else if($scope.mobileType==MobileTypes.iPhone||$scope.mobileType==MobileTypes.iPad){$scope.mobileType==MobileTypes.iPad;var arrButton=["取消","确定"];openDialog("请点击右上角在浏览器中打开下载","",arrButton,null,function(r){})}}else $scope.mobileType==MobileTypes.Android?window.location.href=isXiaoMiBrowser()?appDownloadUrl.android:appDownloadUrl.webchat:($scope.mobileType==MobileTypes.iPhone||$scope.mobileType==MobileTypes.iPad)&&($scope.mobileType==MobileTypes.iPad?window.open(appDownloadUrl.ios):window.location.href=appDownloadUrl.ios)},500)},$scope.close=function(){$scope.show=!1,setCloseDownloadApp(),$scope.$emit("CtrlDownloadShow",$scope.show)}}),app.controller("cartController",function($rootScope,$scope,httpRequest,dataStringify,analytics,$location){$scope.products=[],$scope.empty=!1;var cartProducts=[];$scope.totalAmountValue=0,$scope.back=function(){history.back()};for(var length=cartProducts.length,goodsId="",quantity="",checkeds="",i=0;length>i;i++){var chk=cartProducts[i].checked?"1":"0";length-1>i?(goodsId=goodsId+cartProducts[i].id+",",quantity=quantity+cartProducts[i].num+",",checkeds=checkeds+chk+","):(goodsId+=cartProducts[i].id,quantity+=cartProducts[i].num,checkeds+=chk)}$scope.getCart=function(){httpRequest.APIPOST("/cart/list_v1.4",dataStringify("platform=all&token="+$rootScope.tokenInfo.token),{"content-type":"application/x-www-form-urlencoded"}).then(function(result){result&&result.code==statusCode.Success?($scope.products=result.result.normal,$scope.cartInfo=result.result,$scope.empty=$scope.products?$scope.products.length<1?!0:!1:!0):alertWarning(result.msg)})},$scope.getCart(),$rootScope.$on("CtrlLoginModule",function(){$scope.getCart()}),(getMobileType()==MobileTypes.iPhone||getMobileType()==MobileTypes.iPad)&&(window.onresize=function(){refixNavBottom()},window.onresize()),$scope.reduceNum=function(index){$scope.products[index].quantity--,$scope.synCart()},$scope.addNum=function(index){$scope.products[index].quantity++,$scope.synCart(),$scope.totalAmount()},$scope.validNum=function(index){$scope.products[index].quantity=""==validInteger($scope.products[index].quantity)?0:parseInt(validInteger($scope.products[index].quantity)),$scope.synCart(),$scope.totalAmount()},$scope.checked=function(product,parentIndex,index){return product.checked=product.checked?0:1,"库存不足"==$scope.products[index].error?void(product.checked=0):($scope.updateStatus(),void $scope.totalAmount(parentIndex,index))},$scope.deleteItem=function(product){var data="platform=all&token="+$rootScope.tokenInfo.token+"&goodsId="+product.id;httpRequest.APIPOST("/cart/delete",dataStringify(data),{"content-type":"application/x-www-form-urlencoded"}).then(function(result){result&&result.code==statusCode.Success&&$scope.getCart()})},$scope.totalNum=function(){var totalNum=0;if($scope.products)for(var i=0;i<$scope.products.length;i++)$scope.products[i].checked&&(totalNum+=parseInt($scope.products[i].quantity)?parseInt($scope.products[i].quantity):0);return totalNum},$scope.isAllChecked=function(){if(null==$scope.products||0==$scope.products.length)return!1;for(var i=0;i<$scope.products.length;i++)if(null==$scope.products[i].checked||!$scope.products[i].checked)return!1;return!0},$scope.checkAll=function(){if($scope.products&&$scope.products.length>0)for(var isAllChecked=$scope.isAllChecked(),i=0;i<$scope.products.length;i++)$scope.products[i].checked=!isAllChecked;$scope.updateStatus(),$scope.totalAmount()},$scope.go=function(){if(0==$scope.totalNum())return void alertWarning("您还没有选择商品哦");for(var ids=[],nums=[],i=0;i<$scope.products.length;i++)1==$scope.products[i].checked&&(ids.push($scope.products[i].id),nums.push($scope.products[i].quantity));$location.path("/pay/999/1").search({goodsId:ids.join(","),quantity:nums.join(",")}),$scope.$apply($location)},$scope.edit=function(){$scope.editMode=!0},$scope.done=function(){$scope.editMode=!1,$scope.totalAmount()},$scope.remove=function(){if(0==$scope.totalNum())return void alertWarning("请选中您要删除的商品");var arrButton=["取消","确定"];openDialog("确认从购物袋中删除所有选中的商品？","删除商品",arrButton,null,function(r){if(r){for(var goodsIds=[],i=0;i<$scope.products.length;i++)$scope.products[i].checked&&goodsIds.push($scope.products[i].id);var data="platform=all&token="+$rootScope.tokenInfo.token+"&goodsId="+goodsIds.join(",");httpRequest.APIPOST("/cart/delete",dataStringify(data),{"content-type":"application/x-www-form-urlencoded"}).then(function(result){result&&result.code==statusCode.Success&&$scope.getCart()})}})},$scope.totalAmount=function(){$scope.totalAmountValue=0;for(var goodsIds=($scope.products,[]),goodsQuantity=[],i=0;i<$scope.products.length;i++)$scope.products[i].checked&&(goodsIds.push($scope.products[i].id),goodsQuantity.push($scope.products[i].quantity));return 0==goodsIds.length?($scope.cartInfo.total=0,$scope.cartInfo.oldTotal=0,void($scope.cartInfo.js=0)):void httpRequest.APIPOST("/cart/price_v1.4",dataStringify("platform=all&token="+$rootScope.tokenInfo.token+"&goodsId="+goodsIds.join(",")+"&quantity="+goodsQuantity.join(",")),{"content-type":"application/x-www-form-urlencoded"},!0).then(function(result){result&&result.code==statusCode.Success?($scope.totalAmountValue=0,$scope.cartInfo=result.result):alert(result.msg)})},$scope.synCart=function(){for(var goodsIds=[],goodsQuantity=[],checkeds=[],i=0;i<$scope.products.length;i++)checkeds.push($scope.products[i].checked?1:0),goodsIds.push($scope.products[i].id),goodsQuantity.push($scope.products[i].quantity);var data="platform=all&token="+$rootScope.tokenInfo.token+"&goodsId="+goodsIds.join(",")+"&quantity="+goodsQuantity.join(",");httpRequest.APIPOST("/cart/update",dataStringify(data),{"content-type":"application/x-www-form-urlencoded"}).then(function(result){result&&result.code==statusCode.Success})},$scope.updateStatus=function(){for(var goodsIds=[],checkeds=[],i=0;i<$scope.products.length;i++)checkeds.push($scope.products[i].checked?1:0),goodsIds.push($scope.products[i].id);var data="platform=all&token="+$rootScope.tokenInfo.token+"&goodsId="+goodsIds.join(",")+"&checked="+checkeds.join(",");httpRequest.APIPOST("/cart/status",dataStringify(data),{"content-type":"application/x-www-form-urlencoded"}).then(function(result){result&&result.code==statusCode.Success})}}),app.controller("orderListController",function($rootScope,$scope,httpRequest,dataStringify,analytics,$location){$scope.orders=[],$scope.go=function(){$location.path("/products")},$scope.getOrderStatus=function(status){return 1==status?"等待付款":2==status?"等待确认收货":3==status?"交易成功":4==status?"已取消":5==status?"退款中":6==status?"已退款":7==status?"已失效":void 0};var pageNo=1,pageSize=100;$rootScope.$on("CtrlLoginModule",function(){$scope.getOrders()}),$scope.getOrders=function(){showLoading(),httpRequest.APIPOST("/orderLd/list",dataStringify("platform=all&token="+$rootScope.tokenInfo.token+"&category=1&pageNo="+pageNo+"&pageSize="+pageSize),{"content-type":"application/x-www-form-urlencoded"}).then(function(result){"success"===result.msg?($scope.orders=result.result,hideLoading(),$scope.orders&&$scope.orders.length<1&&($scope.orders=null)):(hideLoading(),alert(result.msg))})},$scope.getOrders(),$scope.pay=function(orderNum,totalPrice,quantity,id){httpRequest.APIPOST("/orderLd/validate",dataStringify("platform=all&token="+$rootScope.tokenInfo.token+"&orderId="+id),{"content-type":"application/x-www-form-urlencoded"}).then(function(result){"success"===result.msg?$location.path("/pay/confirm/"+orderNum+"/"+totalPrice+"/"+quantity):alertWarning(result.msg)})},$scope.takeOverOrder=function(id,index){showLoading(),httpRequest.APIPOST("/orderLd/operate",dataStringify("action=confirm&platform=all&token="+$rootScope.tokenInfo.token+"&orderId="+id),{"content-type":"application/x-www-form-urlencoded"}).then(function(result){"success"===result.msg?(alertSuccess("收货成功！"),$scope.orders[index].status=3,hideLoading()):(hideLoading(),alert(result.msg))})},$scope.back=function(){$location.path("/myProfile")}}),app.controller("orderDetailController",function($rootScope,$scope,httpRequest,dataStringify,analytics,$location,$window,$routeParams){$scope.orderId=$routeParams.id,$scope.totalNum=0,$scope.totalAmount=0;$scope.token;$scope.getOrderStatus=function(status){return 1==status?"等待付款":2==status?"等待确认收货":3==status?"交易成功":4==status?"已取消":5==status?"退款中":6==status?"已退款":7==status?"已失效":void 0},$scope.deleteOrder=function(id){var arrButton=["取消","确定"];openDialog("确认删除当前订单？","",arrButton,null,function(r){r&&(showLoading(),httpRequest.APIPOST("/orderLd/operate",dataStringify("action=delete&platform=all&token="+$rootScope.tokenInfo.token+"&orderId="+id),{"content-type":"application/x-www-form-urlencoded"}).then(function(result){"success"===result.msg?(alertSuccess("删除成功！"),$location.path("/orderList")):(hideLoading(),alert(result.msg))}))})},$scope.drawbackOrder=function(id){var arrButton=["取消","确定"];openDialog("确认退款？","",arrButton,null,function(r){r&&(showLoading(),httpRequest.APIPOST("/orderLd/operate",dataStringify("action=refund&platform=all&token="+$rootScope.tokenInfo.token+"&orderId="+id),{"content-type":"application/x-www-form-urlencoded"}).then(function(result){"success"===result.msg?(alertSuccess("退款成功！"),$scope.order.status=5,hideLoading()):(hideLoading(),alert(result.msg))}))})},$scope.cancelOrder=function(id){var arrButton=["取消","确定"];openDialog("确认取消当前订单？","",arrButton,null,function(r){r&&(showLoading(),httpRequest.APIPOST("/orderLd/operate",dataStringify("action=cancel&platform=all&token="+$rootScope.tokenInfo.token+"&orderId="+id),{"content-type":"application/x-www-form-urlencoded"}).then(function(result){"success"===result.msg?(alertSuccess("取消成功！"),$scope.order.status=4,hideLoading()):(hideLoading(),alert(result.msg))}))})},$scope.takeOverOrder=function(id){showLoading(),httpRequest.APIPOST("/orderLd/operate",dataStringify("action=confirm&platform=all&token="+$rootScope.tokenInfo.token+"&orderId="+id),{"content-type":"application/x-www-form-urlencoded"}).then(function(result){"success"===result.msg?(alertSuccess("收货成功！"),$scope.order.status=3,hideLoading()):(hideLoading(),alert(result.msg))})},$rootScope.$on("CtrlLoginModule",function(){$scope.getOrderDetail($scope.orderId)}),$scope.getOrderDetail=function(orderId){orderId?httpRequest.APIPOST("/orderLd/detail",dataStringify("platform=all&&orderId="+$scope.orderId+"&token="+$scope.tokenInfo.token),{"content-type":"application/x-www-form-urlencoded"}).then(function(result){if("success"===result.msg){if($scope.order=result.result,$scope.order&&$scope.order.goodsList&&$scope.order.goodsList.length>0){for(var i=0;i<$scope.order.goodsList.length;i++)$scope.order.goodsList[i].quantity=parseInt($scope.order.goodsList[i].quantity),$scope.totalNum+=$scope.order.goodsList[i].quantity,$scope.totalAmount+=$scope.order.goodsList[i].quantity*$scope.order.goodsList[i].buyPrice;"''"==$scope.order.comments&&($scope.order.comments="")}}else alert(result.msg)}):$scope.order=!1},$scope.getOrderDetail($scope.orderId),$scope.showLarge=function(imgUrl){showLargeImage(imgUrl)},$scope.go=function(){$location.path("/products")},$scope.pay=function(orderNum,totalPrice,quantity,id){httpRequest.APIPOST("/orderLd/validate",dataStringify("platform=all&token="+$rootScope.tokenInfo.token+"&orderId="+id),{"content-type":"application/x-www-form-urlencoded"}).then(function(result){"success"===result.msg?$location.path("/pay/confirm/"+orderNum+"/"+totalPrice+"/"+quantity):alertWarning(result.msg)})},$scope.back=function(){$location.path("/orderList")}}),app.controller("paymentLDController",function($rootScope,$scope,httpRequest,dataStringify,analytics,$location){$scope.step=1,$scope.toggleOn=!1,$scope.takeoverMethod=1,$scope.toggleTakeover=function(){$scope.toggleOn=$scope.toggleOn?!1:!0};var goodsId=$location.search().goodsId,quantity=$location.search().quantity;$scope.selectTakeover=function(t){$scope.toggleOn=!1,$scope.takeoverMethod=t},$scope.enterAddress=function(s){$scope.step=s,$scope.addressInfo=$.extend(!0,{},$scope.defaultAddress),1==s?($("#appDateTime").val(""),$scope.step=1==$scope.takeoverMethod?2:3):$("#appDateTime").val($scope.addressInfo.returnDate)},$scope.goodsItems=function(){$scope.step=4},$scope.back=function(){return $scope.step>1?void($scope.step=1):void history.back()},$scope.getOrderPrice=function(){var data="platform=all&token="+$rootScope.tokenInfo.token+"&goodsId="+$location.search().goodsId+"&quantity="+$location.search().quantity;httpRequest.APIPOST("/orderLd/price",dataStringify(data),{"content-type":"application/x-www-form-urlencoded"}).then(function(result){result&&result.code==statusCode.Success?$scope.orderPrice=result.result||{}:alertWarning(result.msg)})},$scope.getDefaultAddress=function(){var data="platform=all&token="+$rootScope.tokenInfo.token;httpRequest.APIPOST("/address/default",dataStringify(data),{"content-type":"application/x-www-form-urlencoded"}).then(function(result){result&&result.code==statusCode.Success?($scope.defaultAddress=result.result,null!=$scope.defaultAddress):alertWarning(result.msg)})},$scope.saveDefaultAddress=function(){if(1==$scope.takeoverMethod){if(!$scope.addressInfo.contact||""==$scope.addressInfo.contact.toString().trim())return void alertWarning("请填写联系人姓名");if($scope.addressInfo.contact.toString().length<2||$scope.addressInfo.contact.toString().length>20)return void alertWarning("请输入2~20位的联系人姓名");if(!$scope.addressInfo.mobile||""==$scope.addressInfo.mobile)return void alertWarning("请填写手机号码");if(11!=$scope.addressInfo.mobile.toString().length)return void alertWarning("请输入11位的手机号码");var flightTime=$("#appDateTime").val();if(!flightTime||""==flightTime)return void alertWarning("请选择回程日期");if($scope.addressInfo.returnTime=flightTime,!$scope.addressInfo.returnFlightno||""==$scope.addressInfo.returnFlightno)return void alertWarning("请输入回程航班号");if(new Date(flightTime.replace(/-/g,"/"))<$scope.minDateTime)return void alertWarning("起飞时间请选择1小时后")}else{if(!$scope.addressInfo.contact||""==$scope.addressInfo.contact.toString().trim())return void alertWarning("请填写联系人姓名");if($scope.addressInfo.contact.toString().length<2||$scope.addressInfo.contact.toString().length>20)return void alertWarning("请输入2~20位的联系人姓名");if(!$scope.addressInfo.mobile||""==$scope.addressInfo.mobile)return void alertWarning("请填写手机号码");if(11!==$scope.addressInfo.mobile.toString().length)return void alertWarning("请输入11位的手机号码");if(!$scope.addressInfo.hotelName||""==$scope.addressInfo.hotelName)return void alertWarning("请输入酒店名称");if($scope.addressInfo.hotelName.length<5||$scope.addressInfo.hotelName.length>50)return void alertWarning("请输入5-50位的酒店名称");if(!$scope.addressInfo.hotelPickupDate||""==$scope.addressInfo.hotelPickupDate)return void alertWarning("请输入取货日期");if(!$scope.addressInfo.hotelPhone||""==$scope.addressInfo.hotelPhone)return void alertWarning("请输入酒店电话");if($scope.addressInfo.hotelPhone.length<9||$scope.addressInfo.hotelPhone.length>13)return void alertWarning("请输入9-13位酒店电话");if(!$scope.addressInfo.hotelAddress||""==$scope.addressInfo.hotelAddress.toString().trim())return void alertWarning("请填写酒店地址");if($scope.addressInfo.hotelAddress.toString().length<5||$scope.addressInfo.hotelAddress.toString().length>100)return void alertWarning("请输入5~100位的酒店地址")}$scope.search(function(){var data="";data=2==$scope.takeoverMethod?"platform=all&token="+$rootScope.tokenInfo.token+"&contact="+$scope.addressInfo.contact+"&hotelName="+$scope.addressInfo.hotelName+"&hotelPickupDate="+$scope.addressInfo.hotelPickupDate+"&hotelPhone="+$scope.addressInfo.hotelPhone+"&hotelAddress="+$scope.addressInfo.hotelAddress+"&mobile="+$scope.addressInfo.mobile:"platform=all&token="+$rootScope.tokenInfo.token+"&returnTime="+$("#appDateTime").val()+"&contact="+$scope.addressInfo.contact+"&returnAirportId="+$scope.addressInfo.returnAirportId+"&mobile="+$scope.addressInfo.mobile+"&returnFlightno="+$scope.addressInfo.returnFlightno,httpRequest.APIPOST("/address/add",dataStringify(data),{"content-type":"application/x-www-form-urlencoded"}).then(function(result){"success"===result.msg?($scope.step=1,$scope.$apply($scope.step),$scope.getDefaultAddress(),$scope.$apply($scope.defaultAddress)):alertWarning(result.msg)})})},$scope.getDefaultAddress(),$scope.getOrderPrice(),$rootScope.$on("CtrlLoginModule",function(){$scope.getDefaultAddress(),$scope.getOrderPrice()});var startdate=new Date;startdate.setHours(startdate.getHours()+1);var m=startdate.getMinutes()%5;0!=m&&startdate.setMinutes(startdate.getMinutes()+(5-m)),startdate.setSeconds(0),startdate.setMilliseconds(0),$scope.minDateTime=startdate;var enddate=new Date;enddate.setMonth(enddate.getMonth()+6),enddate.setHours(23),enddate.setMinutes(59),enddate.setSeconds(59),enddate.setMilliseconds(999),$scope.maxDateTime=enddate,opt.datetime={dateOrder:"yymmdd",dateFormat:"yyyy-mm-dd",preset:"datetime",minDate:startdate,maxDate:enddate,stepMinute:5,onSelect:function(){$scope.time=$("#appDateTime").val(),event.stopPropagation()}};{var optDateTime=$.extend(opt.datetime,opt.Default);$.extend(opt.time,opt.Default)}$("#appDateTime").mobiscroll(optDateTime).date(optDateTime),$("#appDateTime2").mobiscroll(optDateTime).date(optDateTime),$scope.search=function(callback){if(2==$scope.takeoverMethod)return void callback();var flightNo=$scope.addressInfo.returnFlightno;if(void 0==flightNo&&(flightNo=""),flightNo.length>=2&&$("#appDateTime").val()){var data="platform=all&backFlightno="+flightNo+"&backDate="+$("#appDateTime").val();httpRequest.APIPOST("/flight/back",dataStringify(data),{"content-type":"application/x-www-form-urlencoded"}).then(function(result){result&&result.code==statusCode.Success?($scope.addressInfo.returnAirportId=result.result.returnAirportId,$scope.addressInfo.returnAirport=result.result.returnAirport,$scope.addressInfo.returnTime=result.result.returnTime,$scope.time||($scope.time=""),$("#appDateTime").val($("#appDateTime").val().split(" ")[0]+" "+result.result.returnTime),callback()):($scope.addressInfo.returnAirportId=-1,$scope.addressInfo.returnAirport="",alertWarning(result.msg))})}},$scope.isGoPay=!1,$scope.generateOrder=function(){if(!$scope.isGoPay){var comment=$scope.comments?"&comments="+$scope.comments:"&comments=''",data="";if(null==$scope.defaultAddress)return void alertWarning("请填写联系人信息");if(2==$scope.takeoverMethod)data="platform=all&token="+$rootScope.tokenInfo.token+"&contact="+$scope.defaultAddress.contact+"&pickupWay=2&hotelName="+$scope.defaultAddress.hotelName+"&hotelPhone="+$scope.defaultAddress.hotelPhone+"&hotelAddress="+$scope.defaultAddress.hotelAddress+"&pickupDate="+$scope.defaultAddress.hotelPickupDate+"&mobile="+$scope.defaultAddress.mobile+"&goodsId="+goodsId+"&quantity="+quantity+comment;else{if(null==$scope.defaultAddress.returnDate)return void alertWarning("请填写完整回程信息");if(null==$scope.defaultAddress.returnTime)return void alertWarning("请填写完整回程信息");data="platform=all&token="+$rootScope.tokenInfo.token+"&pickupWay=1&contact="+$scope.defaultAddress.contact+"&mobile="+$scope.defaultAddress.mobile+"&returnTime="+$scope.defaultAddress.returnDate+" "+$scope.defaultAddress.returnTime+"&returnAirportId="+$scope.defaultAddress.returnAirportId+"&returnFlightno="+$scope.defaultAddress.returnFlightno+"&goodsId="+goodsId+"&quantity="+quantity+comment
}httpRequest.APIPOST("/orderLd/add",dataStringify(data),{"content-type":"application/x-www-form-urlencoded"}).then(function(result){"success"===result.msg?($scope.isGoPay=!0,$("#btnOrder").text("正在下单..."),$location.path("/pay/confirm/"+result.result.orderNum+"/"+$scope.orderPrice.total+"/"+$scope.orderPrice.totalNum)):alertWarning(result.msg)})}}}),app.controller("dividedPayController",function($rootScope,$scope,httpRequest,dataStringify,analytics,$location,$window,$routeParams){$scope.order={},$scope.order.orderNum=$routeParams.orderNum,$scope.order.totalPrice=$routeParams.totalPrice,$scope.order.quantity=$routeParams.quantity,$scope.isWechat=easybuy.isWechat,$scope.isShowTips=!1,$scope.payWay=1,$scope.pay=function(){return $scope.isWechat&&1==$scope.payWay?void($scope.isShowTips=!0):void(window.location.href=1==$scope.payWay?1==$scope.payWay&&$scope.isWechat?paymentUrl+"callback=2&out_trade_no="+$scope.order.orderNum+"&total_fee="+$scope.order.totalPrice:paymentUrl+"callback=4&out_trade_no="+$scope.order.orderNum+"&total_fee="+$scope.order.totalPrice:serviceUrl+"/order/pay/orderid/"+$scope.order.orderNum+"/amount/"+$scope.order.totalPrice+"/address/hiker/time/201508221140")},$scope.Payments=easybuy.Payments;for(var isChecked=!1,i=$scope.Payments.length-1;i>=0;i--)$scope.Payments[i].id!=easybuy.PaymentMethods.WechatPay||easybuy.isWechat?$scope.Payments[i].checked&&(isChecked=!0):$scope.Payments.splice(i,1);isChecked||$.each($scope.Payments,function(i,item){return item.id==easybuy.PaymentMethods.AlipayWeb?(item.checked=!0,!1):void 0}),$scope.checked=function(payment){$.each($scope.Payments,function(i,item){item.checked=!1}),payment.checked=!0,$scope.payWay=payment.id},$scope.back=function(){history.back()};var t=getToken()||{};t.isFresh||(location.reload(),t.isFresh=1,setToken(t))}),app.controller("successController",function($rootScope,$scope,httpRequest,analytics,$location,$window,$routeParams){var isApp="app"==$location.search().payType?!0:!1;$scope.isApp=isApp,$routeParams.ordersn&&(removeOrder(),$scope.time=$routeParams.time,$scope.address=$routeParams.address),$scope.goHome=function(){return isApp?void(window.location.href=easybuy.appActivity+"?action=17"):void $location.path("/products")},$scope.view=function(){return isApp?void(window.location.href=easybuy.appActivity+"?action=16&orderId="+$routeParams.ordersn):void $location.path("/orderDetail/"+$routeParams.ordersn)},$scope.back=function(){$location.path("/products")}}),app.controller("errorController",function($rootScope,$scope,httpRequest,dataStringify,analytics,$location,$window,$routeParams){var isApp="app"==$location.search().payType?!0:!1;$scope.isApp=isApp,$scope.goHome=function(){return isApp?void(window.location.href=easybuy.appActivity+"?action=17"):void $location.path("/products")},$scope.again=function(){if(isApp)return void(window.location.href=easybuy.appActivity+"?action=18");if($routeParams.orderId){return void $location.path("/products")}else $location.path("/products")},$scope.back=function(){$location.path("/products")}}),app.controller("myIncomeController",function($rootScope,$scope,httpRequest,dataStringify,analytics,$location){$scope.step=1,$scope.withDraw=function(t){if(0===t)return void($scope.step=2);var account=$scope.account||"",name=$scope.name||"",mobile=$scope.mobile||"";if(!account)return void alertWarning("请输入支付宝账号");if(!name)return void alertWarning("请输入支付宝姓名");if(!mobile||mobile&&mobile.length<1)return void alertWarning("请输入手机号");if(11!=mobile.length)return void alertWarning("请输入11位的手机号码");var data="platform=all&token="+$rootScope.tokenInfo.token+"&account="+account+"&name="+name+"&mobile="+mobile;httpRequest.APIPOST("/ldIncome/apply",dataStringify(data),{"content-type":"application/x-www-form-urlencoded"}).then(function(result){result&&result.code==statusCode.Success?(alertWarning("申请成功，请等待审核"),$scope.step=1,$scope.getIncomeList(1),$scope.getIncomeList(2)):alertWarning(result.msg)})},$scope.back=function(){return $scope.step>1?void($scope.step=1):void $location.path("/myProfile")},$scope.incomeList1=[],$scope.incomeList2=[],$scope.incomeList3=[],$scope.getIncomeList=function(s){httpRequest.APIPOST("/ldIncome/listByStatus",dataStringify("platform=all&token="+$rootScope.tokenInfo.token+"&status="+s),{"content-type":"application/x-www-form-urlencoded"}).then(function(result){result&&result.code==statusCode.Success?(1==s&&($scope.incomeList1=result.result),2==s&&($scope.incomeList2=result.result),3==s&&($scope.incomeList3=result.result)):alertWarning(result.msg)})},$scope.getIncomeList(1),$scope.getIncomeList(2),$scope.getIncomeList(3),$rootScope.$on("CtrlLoginModule",function(){$scope.getIncomeList(1),$scope.getIncomeList(2),$scope.getIncomeList(3)})}),app.controller("myWishController",function($rootScope,$scope,httpRequest,dataStringify,analytics,$location){$scope.step=1,$scope.saveWish=function(wish){if(!wish)return void alertWarning("请输入心愿产品名称");if(!wish.name)return void alertWarning("请输入心愿产品名称");if(!wish.feature)return void alertWarning("请输入500位以内的产品特点");if(wish.name.length<5||wish.name.length>100)return void alertWarning("请输入5-100位以内的心愿产品名称");if(!wish.feature)return void alertWarning("请输入500位以内的产品特点");if(wish.feature.length>500)return void alertWarning("请输入500位以内的产品特点");wish.link=wish.link?wish.link:"";var data="platform=all&token="+$rootScope.tokenInfo.token+"&name="+wish.name+"&link="+wish.link+"&feature="+wish.feature,apiUrl="/ldWish/add";wish.id&&(apiUrl="/ldWish/edit",data="platform=all&token="+$rootScope.tokenInfo.token+"&name="+wish.name+"&link="+wish.link+"&feature="+wish.feature+"&id="+wish.id),httpRequest.APIPOST(apiUrl,dataStringify(data),{"content-type":"application/x-www-form-urlencoded"}).then(function(result){result&&result.code==statusCode.Success?(alertWarning("提交成功！"),$scope.getWishList(),$scope.step=2):alertWarning(result.msg)})},$scope.wishNow=function(){$scope.step=2},$scope.editWish=function(id,index){$scope.wish=$scope.wishList[index],$scope.step=2},$scope.back=function(){return $scope.step>1?void($scope.step=1):void $location.path("/myProfile")},$scope.getWishList=function(){httpRequest.APIPOST("/ldWish/list",dataStringify("platform=all&token="+$rootScope.tokenInfo.token),{"content-type":"application/x-www-form-urlencoded"}).then(function(result){result&&result.code==statusCode.Success?$scope.wishList=result.result:alertWarning(result.msg)})},$scope.getWishList(),$rootScope.$on("CtrlLoginModule",function(){$scope.getWishList()})}),app.controller("myController",function($rootScope,$scope,httpRequest,$http,dataStringify,analytics,$location,$window,$routeParams){if($rootScope.$on("CtrlUserModule",function(event,isLogin){$scope.isLogin=isLogin}),getToken()){var tmptoken=getToken().token;if(tmptoken){var tmpdata2="platform=all&token="+tmptoken;httpRequest.APIPOST("/mine/index",dataStringify(tmpdata2),{"content-type":"application/x-www-form-urlencoded"}).then(function(result){if(result&&result.code==statusCode.Success){var userInfo=result.result;if($scope.isLogin=!0,$scope.user={},$scope.user.token=tmptoken,$scope.user.openId="0",$scope.user.source=4,$scope.user.nickname=userInfo.nickname,$scope.user.headimgurl=userInfo.avatar,$scope.user.mobile=userInfo.mobible,$scope.user.category=userInfo.category,$scope.user.realName=userInfo.realname,$scope.user.incomeAmount=userInfo.incomeAmount,$scope.incomeAmount=userInfo.incomeAmount,$scope.user.bind=0,$scope.isNeedBind=!1,setToken($scope.user),$rootScope.tokenInfo=$scope.user,"/myProfile"!=$location.path())return $rootScope.isRootLogin=!0,void $rootScope.$emit("CtrlLoginModule",$rootScope.tokenInfo)}else alertWarning(result.msg)})}}var from=$routeParams.from||"";$scope.isNeedBind=!0,$scope.from=from;var loginFrom=1;$scope.isLogin=!0,$scope.isShowLogoutBtn=!easybuy.isWechat,getToken()?($scope.user=getToken(),$scope.isLogin=!0,$scope.isNeedBind=0==$scope.user.bind||"0"==$scope.user.bind||$scope.user.source&&4==$scope.user?!1:!0,loginFrom=$scope.user.source):$scope.isLogin=!1,$scope.forgot=function(){$location.path("/forgot")},$scope.incomeAmount=$rootScope.tokenInfo?$rootScope.tokenInfo.incomeAmount||0:0,$scope.myInfo=function(){$location.path("/myInfo")},$scope.login=function(){var u=$scope.username,p=$scope.password;if(!u||u&&u.length<1||!p||p&&p.length<1)return void alertWarning("请输入手机号/密码");if(11!=u.length||p.length<4||p.length>20)return void alertWarning("请输入正确的手机号或密码");var data="platform=all&account="+u+"&password="+p+"&category=2";httpRequest.APIPOST("/ldUser/login",dataStringify(data),{"content-type":"application/x-www-form-urlencoded"}).then(function(result){if(result&&result.code==statusCode.Success){var token=result.result.token,data2="platform=all&token="+token;httpRequest.APIPOST("/mine/index",dataStringify(data2),{"content-type":"application/x-www-form-urlencoded"}).then(function(result){if(result&&result.code==statusCode.Success){var userInfo=result.result;if($scope.isLogin=!0,$scope.user={},$scope.user.token=token,$scope.user.openId="0",$scope.user.source=4,$scope.user.nickname=userInfo.nickname,$scope.user.headimgurl=userInfo.avatar,$scope.user.mobile=userInfo.mobible,$scope.user.category=userInfo.category,$scope.user.realName=userInfo.realname,$scope.user.incomeAmount=userInfo.incomeAmount,$scope.incomeAmount=userInfo.incomeAmount,$scope.user.bind=0,$scope.isNeedBind=!1,setToken($scope.user),$rootScope.tokenInfo=$scope.user,"/myProfile"!=$location.path())return $rootScope.isRootLogin=!0,void $rootScope.$emit("CtrlLoginModule",$rootScope.tokenInfo)}else alertWarning(result.msg)})}else alertWarning(result.msg)}),loginFrom=4},$scope.register=function(){$location.path("/register")},$scope.back=function(){$location.path("/products")},$scope.validNum=function(){$scope.username=validInteger($scope.username)},$scope.drawProfie=function(){$(".my-profile").css("height",$(window).width()*(640/242)+"px")},$scope.drawProfie(),$(window).resize(function(){$scope.drawProfie()})}),app.controller("myInfoController",function($rootScope,$scope,httpRequest,$http,dataStringify,analytics,$location){$scope.step=1,$rootScope.$on("CtrlLoginModule",function(event,tokenInfo){$rootScope.tokenInfo=tokenInfo}),$scope.updatePassword=function(){$scope.step=3},$scope.updateName=function(){$scope.username=$rootScope.tokenInfo.realName,$scope.step=2};var loginFrom=1;$scope.logout=function(){var arrButton=["取消","确定"];openDialog("您是否确认退出？",null,arrButton,null,function(r){if(r){if(4==loginFrom){var data="platform=all&token="+$scope.user.token;httpRequest.APIPOST("/user/logout",dataStringify(data),{"content-type":"application/x-www-form-urlencoded"}).then(function(result){result&&result.code==statusCode.Success?($scope.user={},removeToken(),$scope.isLogin=!1,$scope.$apply($scope.isLogin),$scope.$apply($scope.user),location.href=location.href.split("?")[0]):alertWarning(result.msg)})}$scope.user={},removeToken(),$scope.isLogin=!1,$rootScope.isRootLogin=!1,$scope.$apply($scope.isLogin),$scope.$apply($scope.user),$rootScope.$apply($rootScope.isRootLogin),$location.path("/myProfile"),$scope.$apply($location)}})},$scope.username=$rootScope.tokenInfo.realName,$scope.saveName=function(){var name=$scope.username;if(!name||name&&name.length<1)return void alertWarning("请输入您的真实姓名");var data="platform=all&token="+$rootScope.tokenInfo.token+"&realname="+name;httpRequest.APIPOST("/user/updateRealname",dataStringify(data),{"content-type":"application/x-www-form-urlencoded"}).then(function(result){if(result&&result.code==statusCode.Success){$rootScope.tokenInfo.realName=name;var tokenInfo=getToken();tokenInfo.realName=name,setToken(tokenInfo),alertWarning("姓名修改成功。"),$scope.step=1}else alertWarning(result.msg)})},$scope.savePassword=function(){var password=$scope.password,newPassword=$scope.newpassword,newPassword2=$scope.newpassword2;if(!password||password.length<6||password.length>20)return void alertWarning("请输入正确的旧密码");if(!newPassword||newPassword.length<6||newPassword.length>20)return void alertWarning("请输入6~20位的密码");if(!newPassword2||newPassword2.length<6||newPassword2.length>20)return void alertWarning("请输入6~20位的密码");if(newPassword!=newPassword2)return void alertWarning("新密码和确认密码不一致");var data="platform=all&token="+$rootScope.tokenInfo.token+"&oldPassword="+password+"&newPassword="+newPassword;httpRequest.APIPOST("/user/updatePassword",dataStringify(data),{"content-type":"application/x-www-form-urlencoded"}).then(function(result){result&&result.code==statusCode.Success?(alertWarning("密码修改成功。"),$scope.step=1):alertWarning(result.msg)})},$scope.save=function(){2==$scope.step&&$scope.saveName(),3==$scope.step&&$scope.savePassword()},$scope.back=function(){return $scope.step>1?void($scope.step=1):void $location.path("/myProfile")}}),app.controller("registerController",function($rootScope,$scope,httpRequest,$http,dataStringify,analytics,$location){$scope.register=function(){var u=$scope.username,c=$scope.code,p=$scope.password,ic=$scope.inviteCode,name=$scope.name;if(!u||u&&u.length<1)return void alertWarning("请输入手机号");if(11!=u.length)return void alertWarning("请输入11位的手机号码");if(!c||c.toString().length<4||c.toString().length>8)return void alertWarning("请输入验证码");if(!p||p.length<6||p.length>20)return void alertWarning("请输入6~20位的密码");if(!ic||ic.length<7||ic.length>20)return void alertWarning("请输入7位的邀请码");if(!name||name.length<2||name.length>30)return void alertWarning("请输入2-30位真实姓名");$scope.wait=0;var data="platform=all&mobile="+u+"&password="+p+"&code="+c+"&inviteCode="+ic+"&realname="+name;httpRequest.APIPOST("/ldUser/register",dataStringify(data),{"content-type":"application/x-www-form-urlencoded"}).then(function(result){if(result&&result.code==statusCode.Success){var token=result.result.token,data2="platform=all&token="+token;httpRequest.APIPOST("/mine/index",dataStringify(data2),{"content-type":"application/x-www-form-urlencoded"}).then(function(result){if(result&&result.code==statusCode.Success){var userInfo=result.result;$scope.user={},$scope.user.token=token,$scope.user.openId="0",$scope.user.source=4,$scope.user.nickname=userInfo.nickname,$scope.user.headimgurl=userInfo.avatar,$scope.user.mobile=userInfo.mobible,$scope.user.bind=userInfo.bind||0,$scope.user.category=userInfo.category,$scope.user.realName=userInfo.realname,$scope.user.incomeAmount=userInfo.incomeAmount,setToken($scope.user),$location.path("/myProfile")}else alertWarning(result.msg)})}else alertWarning(result.msg)})},$scope.back=function(){$location.path("/myProfile")},$scope.validNum=function(){$scope.username=validInteger($scope.username)},$scope.wait=60;var time=function(){0==$scope.wait?($scope.wait=60,$("#codeClock").css("display","none")):($scope.wait--,$scope.$apply($scope.wait),setTimeout(function(){time()},1e3))};$scope.getCheckCode=function(){if(!$scope.username||$scope.username.toString().length<9||$scope.username.toString().length>13)return void alertWarning("请输入9~13位的手机号码");$("#codeClock").css("display","inline-block"),time();var data="platform=all&type=1&mobile="+$scope.username;httpRequest.APIPOST("/sms/getVerifyCode",dataStringify(data),{"content-type":"application/x-www-form-urlencoded"}).then(function(result){result&&result.code==statusCode.Success||alertWarning(result.msg)})}}),app.controller("forgotController",function($rootScope,$scope,httpRequest,$http,dataStringify,analytics,$location){$scope.register=function(){var u=$scope.username,c=$scope.code,p=$scope.password;if(!u||u&&u.length<1)return void alertWarning("请输入手机号");if(11!=u.length)return void alertWarning("请输入11位的手机号码");if(!c||c.toString().length<4||c.toString().length>8)return void alertWarning("请输入验证码");if(!p||p.length<4||p.length>20)return void alertWarning("请输入4~20位的密码");$scope.wait=0;var data="platform=all&mobile="+u+"&password="+p+"&code="+c;httpRequest.APIPOST("/user/password",dataStringify(data),{"content-type":"application/x-www-form-urlencoded"}).then(function(result){result&&result.code==statusCode.Success?(alertWarning("新密码设置成功！"),$location.path("/products")):alertWarning(result.msg)})},$scope.back=function(){$location.path("/myProfile")},$scope.validNum=function(){$scope.username=validInteger($scope.username)},$scope.wait=60;var time=function(){0==$scope.wait?($scope.wait=60,$("#codeClock").css("display","none")):($scope.wait--,$scope.$apply($scope.wait),setTimeout(function(){time()},1e3))};$scope.getCheckCode=function(){if(!$scope.username||$scope.username.toString().length<9||$scope.username.toString().length>13)return void alertWarning("请输入9~13位的手机号码");$("#codeClock").css("display","inline-block"),time();var data="platform=all&type=2&mobile="+$scope.username;httpRequest.APIPOST("/sms/getVerifyCode",dataStringify(data),{"content-type":"application/x-www-form-urlencoded"}).then(function(result){result&&result.code==statusCode.Success||alertWarning(result.msg)})}});